<!DOCTYPE html>
<!-- adapted from url=https://javascript.info/mouse-drag-and-drop -->
<!-- saved from url=(0051)https://en.js.cx/article/mouse-drag-and-drop/ball3/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
<script src="PersistentRingBuffer.js"></script>

</head>

<body style="height: 200px">

  <p>Drag the Disks to the pegs. Press Shift to rotate the disks. <button id="ResetButton">Reset</button> <button id="BackButton">Back</button></p>
  
  
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 556px; top: 211px;" width="20" height="20" id="Peg1">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 779px; top: 196px;" width="20" height="20" id="Peg2">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 904px; top: 254px;" width="20" height="20" id="Peg3">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 1155px; top: 212px;" width="20" height="20" id="Peg4">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 768px; top: 320px;" width="20" height="20" id="Peg5">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 990px; top: 341px;" width="20" height="20" id="Peg6">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 696px; top: 400px;" width="20" height="20" id="Peg7">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 889px; top: 453px;" width="20" height="20" id="Peg8">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 553px; top: 555px;" width="20" height="20" id="Peg9">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 794px; top: 619px;" width="20" height="20" id="Peg10">
  <img src="assets/Peg.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 1155px; top: 554px;" width="20" height="20" id="Peg11">
  <img src="assets/Disc 1.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 15px; top: 45px;" id="Disc1">
  <img src="assets/Disc 4.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 15px; top: 85px;" id="Disc4">
  <img src="assets/Disc 9.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 15px; top: 125px;" id="Disc9">
  <img src="assets/Disc 11.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 15px; top: 165px;" id="Disc11">
  <img src="assets/Disc 8.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 74px; top: 252px;" id="Disc8">
  <img src="assets/Disc 3.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 104px; top: 310px;" id="Disc3">
  <img src="assets/Disc 10.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 109px; top: 353px;" id="Disc10">
  <img src="assets/Disc 5.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 119px; top: 393px;" id="Disc5">
  <img src="assets/Disc 2.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 132px; top: 428px;" id="Disc2">
  <img src="assets/Disc 7.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 147px; top: 457px;" id="Disc7">
  <img src="assets/Disc 6.png" style="cursor: pointer; position: absolute; z-index: 1000; left: 148px; top: 478px;" id="Disc6">
  
  
  
  <script>
	"use strict";
	// Override the default drag and drop behavior of the browser.
	let noDragFunc = function() { return false; };
	
	/*The class Disc and varaible Disc are to assign the specific disc numbers to be used later on
	in the code. name is for the string of the disc, size is for the radius of the disc, defaultX is
	for the default X position and same for defaultY except for the Y position.*/
	
	class Disc {
		// This will cache a map of all discs, keyed by their name.
		static byName = new Map();
		
		constructor(name, size, defaultX, defaultY) {
			this.name = name;
			this.size = size;
			this.defaultX = defaultX; 
			this.defaultY = defaultY;
			this.rotation = Math.floor((Math.random() * 360) + 1);

			this.element = document.getElementById(name);
			this.element.ondragstart = noDragFunc;
			this.element.onmousedown = diskMove;
			/*This is used to make sure none of the roatations are a number and random so that the roation number can be extracted */
			this.element.style.transform = "rotate(" + this.rotation + "deg)";
			
			this.element.disc = this; // so we can do a reverse lookup in diskMove
			Disc.byName.set(this.name, this); // so we can do a reverse lookup from undos
			
			if (!this.loadTransform()) { // load position and rotation from localStorage
				this.saveTransform(); // or save if it wasn't in localStorage
			}
		}
		
		// Retrieve and return the last transform saved to localStorage. Not necessarily the current transform.
		getSavedTransform() {
			return JSON.parse(localStorage.getItem(this.name + 'Xform'));
		}
		
		// Retrieve and return the current transform. Not necessarily what is saved in localStorage.
		getTransform() {
			return {
				name: this.name, // we can use this to record the whole state
				left: this.element.style.left,
				top: this.element.style.top,
				rotate: this.rotation
			};
		}
		
		// Set the current transform, without changing the transform in localStorage.
		setTransform(xform) {
		    this.element.style.left = xform.left;
			this.element.style.top = xform.top;
			this.element.style.transform = "rotate(" + xform.rotate + "deg)";
			this.rotation = xform.rotate;			
		}
		
		loadTransform() {
			/* This function loads the position and rotation from localStorage */
			let xform = this.getSavedTransform();
			if (xform == null) {
				return false;
			}
		    this.setTransform(xform);
			return true;
		}
		
		saveTransform() {
			/* This stores the place of where the Disc was if the player were to want 
			to close the window and come back later. */
			
			localStorage.setItem(this.name + 'Xform', JSON.stringify(this.getTransform()));
		}
		
		resetTransform() {
			// Reset the transform to the default location and random rotation
			this.element.style.left = this.defaultX + 'px';
			this.element.style.top = this.defaultY + 'px';
			
			//sets random disk rotation
			this.rotation = Math.floor((Math.random() * 360) + 1);
			this.element.style.transform = "rotate(" + this.rotation + "deg)";

			// overwrite the previous saved transform
			this.saveTransform();
		}
	}
	
	var discs = [
		new Disc("Disc1", 174, 15, 45), 
		new Disc("Disc2", 57, 132, 428), 
		new Disc("Disc3", 85, 104, 310), 
		new Disc("Disc4", 174, 15, 85), 
		new Disc("Disc5", 70, 119, 393), 
		new Disc("Disc6", 41, 148, 478), 
		new Disc("Disc7", 42, 147, 457), 
		new Disc("Disc8", 115, 74, 252), 
		new Disc("Disc9", 174, 15, 125), 
		new Disc("Disc10", 80, 109, 353), 
		new Disc("Disc11", 174, 15, 165)
	];
	
	let ResetButton = document.getElementById("ResetButton");
	let BackButton = document.getElementById("BackButton");
	let undoStack = new PersistentRingBuffer("undo", 20);  // save 20 previous actions

	
	function diskMove(event) {
		// Every disc element has a disc object attached to it
		let disc = event.target.disc;
		
		// This object has the pixel positions of each edge of the ball element.
		let rect = disc.element.getBoundingClientRect();
		
		// This object stores how we handle mouse move events. It starts empty.
		var moveHandler;
		
		/* What comes next depends if we're doing rotation or dragging. We'll use the shift key
		   to switch to rotation mode for now, but it could be done using a tool mode or some
		   other way. */
		
		if (!event.shiftKey) {
		
			/*The Disc may already have some rotation to it. If that is so
			the "top left corner" isn't necissarily the top left corner due
			to the rotation. To offset this simply find the center of the Disc
			and subtract half of the height and width of the Disc. This sets
			the true top left of the Disc*/
			let DiscX = ((rect.left + rect.right) / 2) - disc.size;
			let DiscY = ((rect.top + rect.bottom) / 2) - disc.size;
			
			/* To handle dragging mode, we just keep track of where we started, relative to the
			   top left of the element. */
			let offsetX = event.pageX - DiscX;
			let offsetY = event.pageY - DiscY;

			function moveAt(event) {
				/* As we move the mouse, keep that offset constant with the current position. */
				disc.element.style.left = event.pageX - offsetX + 'px';
				disc.element.style.top = event.pageY - offsetY + 'px';
				
				/*getting the constant postition of where the disc is*/
				let rect = disc.element.getBoundingClientRect();
			
				//Array is set up for each peg postition in the X and Y cordinates.
				var pegx = [556, 779, 904, 1155, 768, 990, 696, 889, 553, 794, 1155];
				var pegy = [211,196, 254, 212, 320, 341, 400, 453, 555, 619, 554];
			
				/* Loop goes through and checks to see if center of disc is within 50 pixles of a peg.*/
				for (var i = 0; i < 11; i++) {
					let pegX = pegx[i];
					let pegY = pegy[i];
					if (Math.abs(((rect.left + rect.right) / 2) - pegX) < 50 && Math.abs(((rect.top + rect.bottom) / 2) - pegY) < 50) {
						/*150 is derived from half the length and width of the disc png subtracted from half the length and width of the peg png(24).*/
						disc.element.style.left =  pegX - (disc.size - 9) + "px";
						disc.element.style.top = pegY - (disc.size - 9) + "px";
						
					} 
					
				}
				
			}


			moveHandler = moveAt;
			
		} else {
			/* Now we have to handle rotation mode. In this mode we care about an
			   imaginary vector from the center of the object to the mouse position.
			   As we move the mouse around, the angle between the original vector and
			   the current vector is how much we need to rotate. So we will need to keep
			   track of the center. */
		
			let centerX = (rect.left + rect.right) / 2;
			let centerY = (rect.top + rect.bottom) / 2;
			
			/* And the other point on the line is the mouse. By subtracting the center,
			   we can find the angle of the line. */

			let startVecX = event.pageX - centerX;
			let startVecY = event.pageY - centerY;
			
			/* CSS uses degrees, so we'll convert to those units */
			let radiansToDegrees = 180 / Math.PI;
			
			/* We can get the starting angle using the arctangent: */
			let startAngle = Math.atan2(startVecY, startVecX) * radiansToDegrees;
			
			/* One final complication: Sometimes the object already has some rotation! In that
			   case we would compute the final rotation as
			
			   finalRotation = startRotation + (endAngle - startAngle)
			
			   But only the endAngle is actually changing, so we can rewrite this as:
			
			   angleOffset = startRotation - startAngle;
			   finalRotation = angleOffset + endAngle;
			
			   angleOffset only needs to be computed once: */

			let angleOffset = disc.rotation - startAngle;

			function rotateAt(event) {
				
				/* Find the vector from center to current mouse position. */
				let endVecX = event.pageX - centerX;
				let endVecY = event.pageY - centerY;

				/* Compute the angle of that vector in degrees: */
				let endAngle = Math.atan2(endVecY, endVecX) * radiansToDegrees;

				/* Using the formula above, update the ball rotation. */
				disc.rotation = Math.round(endAngle + angleOffset);

				/* Replace negative rotations with positive ones. */
				if (disc.rotation < 0) disc.rotation += 360;

				/* Assign the CSS transform attribute */
				disc.element.style.transform = "rotate(" + disc.rotation + "deg)";
			}

			moveHandler = rotateAt;
			
		}
		
		/* Assign the appropriate handler. Note that an object covering the whole window
		   - in this case the document itself - has to be the target, since we
		   might move the pointer off the object. */
		document.addEventListener('mousemove', moveHandler);
		
		// When the move is over, remove the event listeners.
		document.onmouseup = function() {
			document.removeEventListener('mousemove', moveHandler);
			document.onmouseup = null;
			
			// Push an array containing one entry: the previously saved transform of this disc.
			undoStack.push([disc.getSavedTransform()]);
			
			disc.saveTransform();
		};
		
	}
	
	/*Simple reset button. Just resets all of the X and Y cordinates for all the Discs. As well as the rotations.*/
	ResetButton.onmousedown = function() {
		
		// Save the previous state of ALL the discs in the undo stack
		undoStack.push(discs.map(disc => disc.getSavedTransform()));
		
		//Sets all discs to their default positions
		discs.forEach(disc => disc.resetTransform());
	}
	
	//This function undoes the user's previous action
	BackButton.onmousedown = function() {
		// Get the most recent element on the undo stack
		let states = undoStack.pop();
		
		// Check if the stack was empty.
		if (states === undefined) {
			return;
		}
		
		// Loop through all the states in the undo operation:
		for (const state of states) {
			// Get the corresponding disc
			let disc = Disc.byName.get(state.name);
			// Update its transform
			disc.setTransform(state);
			// Ensure that transform is saved in localStorage
			disc.saveTransform(state);
		}
	}
		
  </script>

</body></html>
